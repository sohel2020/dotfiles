# Main k3d cluster management function
export DOCKER_HOST="unix://$(podman machine inspect --format '{{.ConnectionInfo.PodmanSocket.Path}}')"

k3d-cluster() {
    local usage_text="Usage: k3d-cluster <command> [OPTIONS]

Manage k3d (k3s in Docker) clusters.

Commands:
    create      Create a new k3d cluster
    delete      Delete existing k3d cluster(s)
    kubeconfig  Merge all k3d cluster kubeconfigs
    help        Show this help message

Options:
    -h, --help  Show help for specific command

Examples:
    k3d-cluster create my-cluster                     # Create cluster named 'my-cluster'
    k3d-cluster create -w 3 dev-cluster              # Create cluster with 3 worker nodes
    k3d-cluster delete                                # Interactive deletion menu
    k3d-cluster delete my-cluster                     # Delete specific cluster
    k3d-cluster kubeconfig                            # Merge all kubeconfigs
    k3d-cluster help                                  # Show this help message
"

    # Check if no arguments provided or help requested
    if [[ $# -eq 0 ]] || [[ "${1:-}" == "help" ]] || [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
        echo "$usage_text"
        return 0
    fi

    local command="$1"
    shift

    case "$command" in
        create)
            _k3d_cluster_create "$@"
            ;;
        delete)
            _k3d_cluster_delete "$@"
            ;;
        kubeconfig)
            _k3d_cluster_kubeconfig "$@"
            ;;
        *)
            echo "‚ùå Error: Unknown command: $command"
            echo ""
            echo "$usage_text"
            return 1
            ;;
    esac
}

# k3d cluster creation subfunction
_k3d_cluster_create() {
    local usage_text="Usage: k3d-cluster create [OPTIONS] <cluster-name>

Create a k3d (k3s in Docker) cluster with ingress-nginx controller.

Arguments:
    <cluster-name>    Name of the k3d cluster to create (default: cluster)

Options:
    -h, --help        Show this help message and exit
    -w, --workers N   Number of worker nodes (default: 2)

Examples:
    k3d-cluster create my-cluster                     # Create cluster named 'my-cluster' with 2 workers
    k3d-cluster create -w 3 dev-cluster              # Create cluster with 3 worker nodes
    k3d-cluster create --help                        # Show this help message
"

    # Check if help is requested
    if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
        echo "$usage_text"
        return 0
    fi

    # Parse options
    local WORKERS=2
    local CLUSTER_NAME=""
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -w|--workers)
                WORKERS="$2"
                shift 2
                ;;
            -*)
                echo "‚ùå Error: Unknown option: $1"
                echo ""
                echo "$usage_text"
                return 1
                ;;
            *)
                CLUSTER_NAME="$1"
                shift
                ;;
        esac
    done

    # Set default cluster name if not provided
    CLUSTER_NAME=${CLUSTER_NAME:-cluster}

    echo "üöÄ Creating k3d cluster: ${CLUSTER_NAME} with ${WORKERS} worker(s)"

    # Create k3d cluster
    k3d cluster create "${CLUSTER_NAME}" \
        --agents "${WORKERS}" \
        --k3s-arg "--disable=traefik@server:0" \
        --wait

    # Setup ingress-nginx (replacing default Traefik)
    echo "üåê Deploying ingress-nginx controller..."
    kubectl apply -f "https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml"

    echo "‚è≥ Waiting for ingress-nginx to be ready..."
    kubectl wait --namespace ingress-nginx \
        --for=condition=ready pod \
        --selector=app.kubernetes.io/component=controller \
        --timeout=90s

    echo "‚úÖ k3d cluster '${CLUSTER_NAME}' created successfully with ${WORKERS} worker(s) and ingress-nginx installed."
}

# k3d cluster deletion subfunction
_k3d_cluster_delete() {
    local usage_text="Usage: k3d-cluster delete [OPTIONS] [cluster-name]

Delete a k3d cluster with interactive selection.

Arguments:
    [cluster-name]    Name of the k3d cluster to delete (optional, will prompt if not provided)

Options:
    -h, --help        Show this help message and exit
    -a, --all         Delete all k3d clusters

Examples:
    k3d-cluster delete                                # Show interactive menu to select cluster
    k3d-cluster delete my-cluster                     # Delete specific cluster
    k3d-cluster delete --all                          # Delete all clusters
    k3d-cluster delete --help                         # Show this help message
"

    # Check if help is requested
    if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
        echo "$usage_text"
        return 0
    fi

    # Check for --all flag
    if [[ "${1:-}" == "-a" ]] || [[ "${1:-}" == "--all" ]]; then
        echo "‚ö†Ô∏è  This will delete ALL k3d clusters!"
        read -q "REPLY?Are you sure you want to continue? (y/N): "
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "üóëÔ∏è  Deleting all k3d clusters..."
            k3d cluster delete --all
            echo "‚úÖ All k3d clusters deleted successfully."
        else
            echo "‚ùå Operation cancelled."
        fi
        return 0
    fi

    # If specific cluster name provided, delete it directly
    if [[ -n "${1:-}" ]]; then
        local CLUSTER_NAME="$1"
        echo "üóëÔ∏è  Deleting k3d cluster: ${CLUSTER_NAME}"
        if k3d cluster delete "${CLUSTER_NAME}"; then
            echo "‚úÖ k3d cluster '${CLUSTER_NAME}' deleted successfully."
        else
            echo "‚ùå Failed to delete cluster '${CLUSTER_NAME}'."
            return 1
        fi
        return 0
    fi

    # Get list of available clusters
    local clusters=($(k3d cluster list --output json 2>/dev/null | jq -r '.[].name' 2>/dev/null))
    
    # Check if jq is available, fallback to simple parsing if not
    if [[ ${#clusters[@]} -eq 0 ]]; then
        clusters=($(k3d cluster list --output name --no-headers 2>/dev/null))
    fi

    if [[ ${#clusters[@]} -eq 0 ]]; then
        echo "‚ÑπÔ∏è  No k3d clusters found."
        return 0
    fi

    # Use fzf for interactive selection if available, otherwise use select

    selected_cluster=$(printf '%s\n' "${clusters[@]}" | fzf \
        --prompt="Select cluster to delete: " \
        --header="üóëÔ∏è  Select a k3d cluster to delete (Esc to cancel)" \
        --height 40% \
        --border \
        --reverse)


    # Check if selection was cancelled
    if [[ -z "$selected_cluster" ]]; then
        echo "‚ùå Operation cancelled."
        return 0
    fi

    # Confirm deletion
    echo "‚ö†Ô∏è  You are about to delete cluster: $selected_cluster"
    read -q "REPLY?Are you sure you want to delete this cluster? (y/N): "
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "üóëÔ∏è  Deleting k3d cluster: ${selected_cluster}"
        if k3d cluster delete "${selected_cluster}"; then
            echo "‚úÖ k3d cluster '${selected_cluster}' deleted successfully."
        else
            echo "‚ùå Failed to delete cluster '${selected_cluster}'."
            return 1
        fi
    else
        echo "‚ùå Operation cancelled."
    fi
}

# k3d kubeconfig merge subfunction
_k3d_cluster_kubeconfig() {
    local usage_text="Usage: k3d-cluster kubeconfig [OPTIONS]

Merge all k3d cluster kubeconfigs into your default kubeconfig.

Options:
    -h, --help        Show this help message and exit

Examples:
    k3d-cluster kubeconfig                            # Merge all k3d kubeconfigs
    k3d-cluster kubeconfig --help                     # Show this help message
"

    # Check if help is requested
    if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
        echo "$usage_text"
        return 0
    fi

    echo "üîó Merging all k3d cluster kubeconfigs..."
    
    if k3d kubeconfig merge --all --kubeconfig-merge-default; then
        echo "‚úÖ Successfully merged all k3d kubeconfigs."
        echo "üí° You can now switch between clusters using 'kubectl config use-context <context-name>'"
    else
        echo "‚ùå Failed to merge kubeconfigs."
        return 1
    fi
}