#!/usr/bin/env bash
# Description: Copy keyboard layout files to ~/Library/Keyboard Layouts
# Copies all files from ~/.config/unibijoy/ to macOS keyboard layouts directory
set -Eeuo pipefail

if [[ -f "$DOTFILES/bin/lib/common.sh" ]]; then
  source "$DOTFILES/bin/lib/common.sh"
else
  echo "Error: Unable to source common.sh"
  exit 1
fi

SOURCE_DIR="$DOTFILES/config/unibijoy"
DEST_DIR="$HOME/Library/Keyboard Layouts"

show_help() {
    echo "Usage: $0"
    echo ""
    echo "Description:"
    echo "  Copies all keyboard layout files from ~/.config/unibijoy/"
    echo "  to ~/Library/Keyboard Layouts/"
    echo ""
    echo "Examples:"
    echo "  $0"
    echo ""
    echo "File Requirements:"
    echo "  - Source directory: ~/.config/unibijoy/ (must exist)"
    echo "  - Typically copies .keylayout files"
    echo "  - Destination: ~/Library/Keyboard Layouts/"
    echo ""
    echo "Options:"
    echo "  -h, --help     Show this help message"
}

check_source_directory() {
    if [ ! -d "$SOURCE_DIR" ]; then
        log_error "Source directory '$SOURCE_DIR' not found."
        log_info "Please create the directory and add your keyboard layout files."
        exit 1
    fi
    
    if [ ! -r "$SOURCE_DIR" ]; then
        log_error "Source directory '$SOURCE_DIR' is not readable."
        log_info "Please check directory permissions and try again."
        exit 1
    fi
    
    # Check if directory has any files
    if [ -z "$(ls -A "$SOURCE_DIR" 2>/dev/null)" ]; then
        log_warning "Source directory '$SOURCE_DIR' is empty."
        log_info "No keyboard layout files to copy."
        exit 0
    fi
}

setup_destination() {
    # Create destination directory if it doesn't exist
    if [ ! -d "$DEST_DIR" ]; then
        log_info "Creating destination directory: $DEST_DIR"
        if ! mkdir -p "$DEST_DIR"; then
            log_error "Failed to create destination directory: $DEST_DIR"
            exit 1
        fi
    fi
    
    # Check if destination is writable
    if [ ! -w "$DEST_DIR" ]; then
        log_error "Destination directory '$DEST_DIR' is not writable."
        log_info "Please check directory permissions."
        exit 1
    fi
}

copy_unibijoys() {
    # Validate source directory
    check_source_directory
    
    # Setup destination directory
    setup_destination
    
    log_info "Copying keyboard layout files..."
    log_info "Source: $SOURCE_DIR"
    log_info "Destination: $DEST_DIR"
    echo ""
    
    local file_count=0
    local success_count=0
    local error_count=0
    
    # Copy files and track results
    for file in "$SOURCE_DIR"/*; do
        if [ -f "$file" ]; then
            file_count=$((file_count + 1))
            local filename=$(basename "$file")
            local dest_file="$DEST_DIR/$filename"
            
            log_info "Copying: $filename"
            
            if cp "$file" "$dest_file"; then
                success_count=$((success_count + 1))
                log_success "✓ Copied: $filename"
                
                # Show file info
                local file_size=$(wc -c < "$file")
                log_info "  Size: $file_size bytes"
                
                # Check if it's a .keylayout file
                if [[ "$filename" == *.keylayout ]]; then
                    log_info "  Type: Keyboard Layout"
                fi
            else
                error_count=$((error_count + 1))
                log_error "✗ Failed to copy: $filename"
            fi
        fi
    done
    
    # Show summary
    echo ""
    log_info "Copy Summary:"
    log_info "  Total files found: $file_count"
    log_success "  Successfully copied: $success_count"
    
    if [ $error_count -gt 0 ]; then
        log_error "  Failed to copy: $error_count"
        exit 1
    else
        log_success "All keyboard layout files copied successfully!"
        
        # Show post-installation note
        if [[ $file_count -gt 0 ]]; then
            echo ""
            log_info "Next Steps:"
            log_info "  1. Go to System Preferences > Keyboard > Input Sources"
            log_info "  2. Click '+' to add your new keyboard layout(s)"
            log_info "  3. Test your keyboard layout in the Input Sources menu"
        fi
    fi
}

# Main script logic
case "${1:-}" in
    "-h"|"--help"|"help")
        show_help
        ;;
    "")
        copy_unibijoys
        ;;
    *)
        log_error "Unknown argument: '$1'"
        echo ""
        show_help
        exit 1
        ;;
esac

